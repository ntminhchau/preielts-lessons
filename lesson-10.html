<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>Lesson 10 - Listening</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reset.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/theme/white.min.css" id="theme">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        :root {
            --audio-panel-width: 300px;
            --audio-panel-transition: width 0.3s ease, padding 0.3s ease;
        }
        body {
            display: flex;
            overflow: hidden;
        }
        .presentation-container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        .reveal {
            width: calc(100% - var(--audio-panel-width));
            height: 100%;
            transition: width 0.3s ease;
        }
        #audio-panel {
            width: var(--audio-panel-width);
            height: 100%;
            background: #f5f5f5;
            border-left: 1px solid #ddd;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: sans-serif;
            transition: var(--audio-panel-transition);
            position: relative;
        }
        #audio-panel-toggle {
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background: #e0e0e0;
            border: 1px solid #ddd;
            border-right: none;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 10;
        }
        .presentation-container.collapsed #audio-panel {
            width: 0;
            padding: 0;
            border-left: none;
        }
        .presentation-container.collapsed .reveal {
            width: 100%;
        }
        .presentation-container.collapsed #audio-panel-toggle i {
            transform: rotate(180deg);
        }

        #audio-panel h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .audio-item { margin-bottom: 15px; }
        .audio-item label { display: block; font-weight: bold; margin-bottom: 5px; }
        .audio-item audio { width: 100%; }

        /* === NEW ARCHITECTURE STYLES === */
        .slide-overlay-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .transform-wrapper {
            position: absolute;
            width: 100%; height: 100%;
            transform-origin: center center;
            transition: transform 0.2s ease;
            pointer-events: auto;
        }
        #annotation-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        .transform-wrapper.panning {
            cursor: grabbing;
            transition: none;
        }
        .transform-wrapper.pannable {
            cursor: grab;
        }
        /* Make reveal background pannable as well */
        .reveal .slide-background.pannable {
             cursor: grab;
        }
        .reveal .slide-background.panning {
             cursor: grabbing;
        }
        
        #zoom-controls { position: absolute; top: 20px; right: calc(var(--audio-panel-width) + 20px); z-index: 30; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; transition: right 0.3s ease;}
        .presentation-container.collapsed #zoom-controls { right: 20px; }
        #zoom-controls button { background: #fff; color: #000; border: 1px solid #ccc; width: 35px; height: 35px; cursor: pointer; }

        .annotation-toolbar { position: fixed; bottom: 20px; left: calc((100% - var(--audio-panel-width)) / 2); transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 8px; border-radius: 8px; z-index: 101; display: flex; align-items: center; gap: 5px; transition: left 0.3s ease; }
        .presentation-container.collapsed .annotation-toolbar { left: 50%; }
        .tool-btn { background: #fff; color: #333; border: none; width: 40px; height: 40px; font-size: 18px; cursor: pointer; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
        .tool-btn.active { background: #007bff; color: white; }
        
        body.annotation-active .transform-wrapper { cursor: crosshair !important; }
        body.annotation-active .reveal .slide-background { cursor: crosshair !important; }

    </style>
</head>
<body>
<div class="presentation-container">
    <div class="reveal">
        <div class="slides">
            <section data-background-image="assets/lesson-10/images/page-1.jpg" data-background-size="contain"></section>
            <section data-background-image="assets/lesson-10/images/page-2.jpg" data-background-size="contain"></section>
            <section data-background-image="assets/lesson-10/images/page-3.jpg" data-background-size="contain"></section>
            <section data-background-image="assets/lesson-10/images/page-4.jpg" data-background-size="contain"></section>
            <section data-background-image="assets/lesson-10/images/page-5.jpg" data-background-size="contain"></section>
        </div>
    </div>
    <div id="audio-panel">
        <button id="audio-panel-toggle"><i class="fa-solid fa-chevron-right"></i></button>
        <h3>Audio Files</h3>
        <div class="audio-item"><label>Exercise 1:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex1.mp3"></audio></div>
        <div class="audio-item"><label>Exercise 2:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex2.mp3"></audio></div>
        <div class="audio-item"><label>Exercise 3:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex3.mp3"></audio></div>
        <div class="audio-item"><label>Exercise 4:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex4.mp3"></audio></div>
        <div class="audio-item"><label>Exercise 5:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex5.mp3"></audio></div>
        <div class="audio-item"><label>Exercise 8:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex8.mp3"></audio></div>
        <div class="audio-item"><label>Exercise 9:</label><audio controls src="assets/lesson-10/audio/lesson-10-ex9.mp3"></audio></div>
    </div>
</div>
    
    <div class="slide-overlay-container">
        <div class="transform-wrapper">
            <canvas id="annotation-canvas"></canvas>
        </div>
    </div>

    <div id="zoom-controls">
        <button id="zoom-in-btn" title="Phóng to">+</button>
        <button id="zoom-out-btn" title="Thu nhỏ">-</button>
        <button id="zoom-reset-btn" title="Reset"><i class="fa-solid fa-expand"></i></button>
    </div>
    <div class="annotation-toolbar">
        <button class="tool-btn" id="pen-tool" title="Vẽ (P)"><i class="fa-solid fa-pencil"></i></button>
        <button class="tool-btn" id="highlight-tool" title="Highlight (H)"><i class="fa-solid fa-highlighter"></i></button>
        <button class="tool-btn" id="line-tool" title="Đường thẳng (L)"><i class="fa-solid fa-minus"></i></button>
        <button class="tool-btn" id="eraser-tool" title="Tẩy (E)"><i class="fa-solid fa-eraser"></i></button>
        <div class="separator" style="width:1px; height:30px; background:#666; margin:0 5px;"></div>
        <input type="color" id="color-picker" title="Chọn màu" value="#FF0000">
        <div class="separator" style="width:1px; height:30px; background:#666; margin:0 5px;"></div>
        <button class="tool-btn" id="clear-tool" title="Xóa hết"><i class="fa-solid fa-trash"></i></button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.js"></script>
    <script>
        Reveal.initialize({ history: false, center: true, slideNumber: true });

        const transformWrapper = document.querySelector('.transform-wrapper');
        const annotationCanvas = document.getElementById('annotation-canvas');
        const overlayContainer = document.querySelector('.slide-overlay-container');
        const ctx = annotationCanvas.getContext('2d');

        let currentTransform = { scale: 1, x: 0, y: 0 };
        const slideAnnotations = new Map();
        let currentTool = '';
        let isDrawing = false;
        let strokeColor = '#ff0000';
        let startX, startY;

        function getCurrentSlideBackground() {
            const slide = Reveal.getCurrentSlide();
            return slide ? slide.querySelector('.slide-background-content') : null;
        }

        function applyTransform() {
            const bg = getCurrentSlideBackground();
            if (bg) {
                bg.style.transform = `translate(${currentTransform.x}px, ${currentTransform.y}px) scale(${currentTransform.scale})`;
                bg.style.transition = 'transform 0.2s ease';
                bg.parentElement.classList.toggle('pannable', currentTransform.scale > 1);
            }
            transformWrapper.style.transform = `translate(${currentTransform.x}px, ${currentTransform.y}px) scale(${currentTransform.scale})`;
        }

        function resizeAndPositionElements() {
            const slide = Reveal.getCurrentSlide();
            if (!slide) return;
            const slideRect = slide.getBoundingClientRect();
            
            overlayContainer.style.top = `${slideRect.top}px`;
            overlayContainer.style.left = `${slideRect.left}px`;
            overlayContainer.style.width = `${slideRect.width}px`;
            overlayContainer.style.height = `${slideRect.height}px`;

            annotationCanvas.width = slideRect.width;
            annotationCanvas.height = slideRect.height;
            
            loadAnnotations();
        }
        
        function resetZoom() {
            currentTransform = { scale: 1, x: 0, y: 0 };
            applyTransform();
        }

        function saveAnnotations() {
            const indices = Reveal.getIndices();
            if (!indices) return;
            const key = `${indices.h}-${indices.v}`;
            if (!isCanvasBlank(annotationCanvas)) {
                slideAnnotations.set(key, annotationCanvas.toDataURL());
            } else {
                slideAnnotations.delete(key);
            }
        }
        function loadAnnotations() {
            const indices = Reveal.getIndices();
            ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
            if (!indices) return;
            const key = `${indices.h}-${indices.v}`;
            if (slideAnnotations.has(key)) {
                const img = new Image();
                img.src = slideAnnotations.get(key);
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }
        function isCanvasBlank(canvas) {
            return !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
        }

        Reveal.on('ready', resizeAndPositionElements);
        Reveal.on('resize', resizeAndPositionElements);
        Reveal.on('slidechanged', event => {
            saveAnnotations();
            resetZoom();
            resizeAndPositionElements();
        });
        window.addEventListener('resize', resizeAndPositionElements);

        document.getElementById('audio-panel-toggle').addEventListener('click', () => {
            document.querySelector('.presentation-container').classList.toggle('collapsed');
            setTimeout(resizeAndPositionElements, 300);
        });

        document.getElementById('zoom-in-btn').addEventListener('click', () => { currentTransform.scale *= 1.2; applyTransform(); });
        document.getElementById('zoom-out-btn').addEventListener('click', () => { currentTransform.scale = Math.max(1, currentTransform.scale / 1.2); applyTransform(); });
        document.getElementById('zoom-reset-btn').addEventListener('click', resetZoom);
        
        let isPanning = false;
        let panStartX, panStartY;
        overlayContainer.addEventListener('mousedown', (e) => {
            if (currentTransform.scale > 1 && currentTool === '') {
                isPanning = true;
                panStartX = e.clientX - currentTransform.x;
                panStartY = e.clientY - currentTransform.y;
                const bg = getCurrentSlideBackground();
                if(bg) {
                    bg.style.transition = 'none';
                    bg.parentElement.classList.add('panning');
                }
                transformWrapper.classList.add('panning');
            }
        });
        window.addEventListener('mousemove', (e) => {
            if (isPanning) {
                currentTransform.x = e.clientX - panStartX;
                currentTransform.y = e.clientY - panStartY;
                applyTransform();
            }
        });
        window.addEventListener('mouseup', () => {
             if (isPanning) {
                isPanning = false;
                const bg = getCurrentSlideBackground();
                if (bg) {
                    bg.parentElement.classList.remove('panning');
                }
                transformWrapper.classList.remove('panning');
            }
        });

        function getDrawPosition(e) {
            const rect = annotationCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const canvasX = clientX - rect.left;
            const canvasY = clientY - rect.top;

            // Reverse the transform to find the original coordinate
            const originalX = (canvasX - currentTransform.x) / currentTransform.scale;
            const originalY = (canvasY - currentTransform.y) / currentTransform.scale;

            return { x: originalX, y: originalY };
        }
        
        function startDrawing(e) {
            if (currentTool === '') return;
            e.preventDefault(); 
            isDrawing = true; 
            const pos = getDrawPosition(e); 
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const pos = getDrawPosition(e); 
            ctx.lineCap = 'round'; 
            ctx.lineJoin = 'round'; 
            switch (currentTool) {
                case 'pen': 
                    ctx.globalCompositeOperation = 'source-over'; 
                    ctx.strokeStyle = strokeColor; 
                    ctx.lineWidth = 5 / currentTransform.scale; 
                    ctx.lineTo(pos.x, pos.y); 
                    ctx.stroke(); 
                    break; 
                case 'highlight': 
                    ctx.globalCompositeOperation = 'source-over'; 
                    ctx.strokeStyle = 'rgba(255, 255, 0, 0.4)'; 
                    ctx.lineWidth = 25 / currentTransform.scale; 
                    ctx.lineTo(pos.x, pos.y); 
                    ctx.stroke(); 
                    break; 
                case 'eraser': 
                    ctx.globalCompositeOperation = 'destination-out'; 
                    ctx.lineWidth = 20 / currentTransform.scale; 
                    ctx.lineTo(pos.x, pos.y); 
                    ctx.stroke(); 
                    break;
            }
        }
        function stopDrawing(e) { 
            if (!isDrawing) return;
            e.preventDefault(); 
            isDrawing = false; 
            if (currentTool === 'line') {
                const pos = getDrawPosition(e); 
                const startPos = getDrawPosition({clientX: startX, clientY: startY});
                ctx.globalCompositeOperation = 'source-over'; 
                ctx.strokeStyle = strokeColor; 
                ctx.lineWidth = 5 / currentTransform.scale; 
                ctx.beginPath(); 
                ctx.moveTo(startPos.x, startPos.y); 
                ctx.lineTo(pos.x, pos.y); 
                ctx.stroke();
            }
        }

        overlayContainer.addEventListener('mousedown', startDrawing, true);
        overlayContainer.addEventListener('mousemove', draw, true);
        window.addEventListener('mouseup', stopDrawing, true);

        document.querySelector('.annotation-toolbar').addEventListener('click', e => {
            const btn = e.target.closest('.tool-btn');
            if (!btn) return;
            
            const selectedTool = btn.id.replace('-tool', '');
            if (selectedTool === 'clear') { 
                if (confirm('Bạn có chắc muốn xóa hết chú thích trên slide này?')) { 
                    ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height); 
                } 
                return; 
            }

            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.body.classList.remove('annotation-active');

            if (currentTool === selectedTool) {
                currentTool = '';
            } else {
                currentTool = selectedTool;
                btn.classList.add('active');
                document.body.classList.add('annotation-active');
            }
        });
        document.getElementById('color-picker').addEventListener('input', e => { strokeColor = e.target.value; });
    </script>
</body>
</html>

