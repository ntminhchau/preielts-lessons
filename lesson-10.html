<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>Lesson 10 - Listening</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reset.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/theme/white.min.css" id="theme">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        :root {
            --r-main-font-size: 28px;
            --r-heading1-size: 2.5em;
            --r-heading2-size: 1.8em;
            --r-heading3-size: 1.5em;
        }
        .reveal .slides section {
            text-align: left;
            box-sizing: border-box;
            padding: 20px 40px;
        }
        .reveal h1, .reveal h2, .reveal h3 {
            text-align: center;
            margin-bottom: 30px;
        }
        .reveal audio {
            width: 100%;
            margin: 15px 0;
        }
        .reveal .exercise-form {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .reveal .exercise-form table { width: 100%; border-collapse: collapse; }
        .reveal .exercise-form td { padding: 8px; border: 1px solid #ddd; }
        .reveal .exercise-form td:first-child { font-weight: bold; width: 30%; }

        /* === NEW ANNOTATION STYLES === */
        #selection-toolbar {
            position: absolute;
            display: none;
            background: #333;
            border-radius: 5px;
            padding: 5px;
            z-index: 1000;
        }
        #selection-toolbar button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        #selection-toolbar button:hover {
            background: #555;
        }
        .highlighted-text {
            background-color: rgba(255, 255, 0, 0.4);
        }
        .underlined-text {
            text-decoration: underline;
            text-decoration-color: red;
            text-decoration-thickness: 2px;
        }
        .strikethrough-text {
            text-decoration: line-through;
        }

        #main-toolbar {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: rgba(0,0,0,0.7);
            padding: 8px;
            border-radius: 8px;
        }
        #main-toolbar button {
            background: #fff; color: #333; border: none;
            width: 40px; height: 40px; font-size: 18px;
            cursor: pointer; border-radius: 5px;
        }
        body.add-note-mode {
            cursor: crosshair;
        }

        .text-note {
            position: absolute;
            width: 200px;
            height: 150px;
            background: #fffbe5;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        .text-note-header {
            background: #f0f0f0;
            padding: 3px;
            cursor: move;
            text-align: right;
        }
        .text-note-header .close-btn {
            border: none;
            background: none;
            cursor: pointer;
            font-weight: bold;
        }
        .text-note textarea {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 10px;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h2>LISTENING: FORM AND NOTE COMPLETION</h2>
                <h4>Quy trình làm bài:</h4>
                <ol>
                    <li>Đọc kỹ hướng dẫn (Vd: Write NO MORE THAN TWO WORDS...).</li>
                    <li>Xác định cần điền TỪ hay SỐ.</li>
                    <li>Xác định loại từ cần điền (danh từ, động từ, tính từ...).</li>
                    <li>Nghe được – điền ngay vào bài.</li>
                    <li>Nghe nhưng chưa chắc – ghi lại dữ kiện nghe được.</li>
                    <li>Kiểm tra lại sau khi làm xong (chính tả, số ít/nhiều, ngữ pháp).</li>
                </ol>
            </section>
            <section>
                <h3>Exercise 1</h3>
                <audio controls src="assets/lesson-10/audio/lesson-10-ex1.mp3"></audio>
                <p>Complete these notes with information from the flight arrivals board below.</p>
                <ul>
                    <li>Spanish flight arrived at (1) .................</li>
                    <li>Flight CCA1550 from (2) ................. arrived at 6.00</li>
                    <li>Emirati flight no. (3) ................. delayed.</li>
                    <li>Flight from Lison landed at terminal (4) .................</li>
                </ul>
                <hr>
                <h3>Exercise 2</h3>
                <audio controls src="assets/lesson-10/audio/lesson-10-ex2.mp3"></audio>
                <p>You will hear a conversation between two friends planning a visit. Complete the notes.</p>
                <ul>
                    <li>Sam arrives at: (1) ................. on (2) .................</li>
                    <li>Airline: (3) ................. Flight number: (4) .................</li>
                </ul>
            </section>
            <section>
                <h3>Exercise 3</h3>
                <audio controls src="assets/lesson-10/audio/lesson-10-ex3.mp3"></audio>
                <p>You will hear a telephone conversation in which Sam is booking a taxi. Complete the form.</p>
                <div class="exercise-form">
                    <table>
                        <tr><td>NAME OF PASSENGER:</td><td>SAM WILLIAMS</td></tr>
                        <tr><td>PICK-UP DATE AND TIME:</td><td>Wed 6th July (1).................</td></tr>
                        <tr><td>PICK-UP POINT:</td><td>(2)................. WILLOWSIDE BANK</td></tr>
                        <tr><td>NO. & STREET:</td><td>(3).................</td></tr>
                        <tr><td>TOWN:</td><td>(4).................</td></tr>
                        <tr><td>POSTCODE:</td><td>(5) 07789 .................</td></tr>
                        <tr><td>DESTINATION:</td><td>HEATHROW - TERMINAL 5</td></tr>
                    </table>
                </div>
            </section>
            <section>
                <h3>Exercise 4</h3>
                <audio controls src="assets/lesson-10/audio/lesson-10-ex4.mp3"></audio>
                <p>You will hear a conversation between a flight attendant and a passenger completing a landing card. Complete the form.</p>
                 <div class="exercise-form">
                    <table>
                        <tr><td>Family name:</td><td>LIU</td></tr>
                        <tr><td>First name(s):</td><td>(1) .................</td></tr>
                        <tr><td>Date of birth:</td><td>(2) .................</td></tr>
                        <tr><td>Contact address in the UK:</td><td>(3) .................</td></tr>
                    </table>
                </div>
            </section>
            <section>
                <h3>Exercise 5</h3>
                <audio controls src="assets/lesson-10/audio/lesson-10-ex5.mp3"></audio>
                 <p>You will hear a telephone conversation between a hotel receptionist and a caller making a reservation. Complete the form.</p>
                <div class="exercise-form">
                     <table>
                        <tr><td>Type of room:</td><td>(1) Single / Double - twin beds / Double - king-sized bed</td></tr>
                        <tr><td>Name:</td><td>(2) .................</td></tr>
                        <tr><td>Home address:</td><td>(3) ................. Avenue, Cambridge</td></tr>
                         <tr><td>Postcode:</td><td>(4) .................</td></tr>
                         <tr><td>Transport:</td><td>(5) .................</td></tr>
                         <tr><td>Meals:</td><td>(6) .................</td></tr>
                         <tr><td>Date of arrival:</td><td>(7) .................</td></tr>
                    </table>
                </div>
            </section>
            <section>
                <h3>Exercise 8</h3>
                 <audio controls src="assets/lesson-10/audio/lesson-10-ex8.mp3"></audio>
                <p>Listen to a recording of an interview in a survey of shopping habits. Complete the notes.</p>
                <ul>
                    <li>Four people in the family - only two (1) .................</li>
                    <li>Mother buys the food. Makes a (2) ................. first.</li>
                    <li>Goes to (3) ................. weekly.</li>
                    <li>Miriam (4) ................. most. Sometimes buys clothes she doesn't like. Takes them back and asks for (5) .................</li>
                </ul>
            </section>
            <section>
                <h3>Exercise 9</h3>
                 <audio controls src="assets/lesson-10/audio/lesson-10-ex9.mp3"></audio>
                <p>Listen to a talk about shopping habits in different countries. Complete the notes.</p>
                <p><b>Who does the shopping?</b></p>
                <ul>
                    <li>In the UK (1) ................. % food bought by women.</li>
                    <li>In some countries (2) ................. % men do grocery shopping.</li>
                    <li>Habits changing - US (3) ................. % of men shop for food.</li>
                </ul>
                 <p><b>Where do people shop?</b></p>
                 <ul>
                    <li>In cities: (4) ................. and (5) .................</li>
                    <li>In country (6) .................</li>
                </ul>
            </section>
        </div>
    </div>
    
    <div id="selection-toolbar">
        <button id="highlight-btn" title="Highlight"><i class="fa-solid fa-highlighter"></i></button>
        <button id="underline-btn" title="Underline"><i class="fa-solid fa-underline"></i></button>
        <button id="strikethrough-btn" title="Strikethrough"><i class="fa-solid fa-strikethrough"></i></button>
    </div>

    <div id="main-toolbar">
        <button id="add-note-btn" title="Thêm ghi chú"><i class="fa-solid fa-note-sticky"></i></button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.js"></script>
    <script>
        Reveal.initialize({ history: false, center: false, slideNumber: true, width: 1280, height: 960 });

        const selectionToolbar = document.getElementById('selection-toolbar');
        const slidesContainer = document.querySelector('.reveal .slides');
        const originalSlideStates = new Map();
        const modifiedSlideStates = new Map();

        // --- PERSISTENCE LOGIC ---
        Reveal.on('ready', () => {
            document.querySelectorAll('.reveal .slides section').forEach((slide, index) => {
                originalSlideStates.set(index, slide.innerHTML);
            });
        });

        Reveal.on('slidechanged', (event) => {
            // Save previous slide state
            const prevIndices = Reveal.getIndices(event.previousSlide);
            const prevKey = `${prevIndices.h}-${prevIndices.v}`;
            if (event.previousSlide) {
                 modifiedSlideStates.set(prevKey, event.previousSlide.innerHTML);
            }

            // Load current slide state
            const currIndices = Reveal.getIndices(event.currentSlide);
            const currKey = `${currIndices.h}-${currIndices.v}`;
            const originalKey = currIndices.h; // Assuming horizontal slides only for simplicity
            
            if (modifiedSlideStates.has(currKey)) {
                event.currentSlide.innerHTML = modifiedSlideStates.get(currKey);
            } else if (originalSlideStates.has(originalKey)) {
                event.currentSlide.innerHTML = originalSlideStates.get(originalKey);
            }
        });

        // --- SELECTION TOOLBAR LOGIC ---
        document.addEventListener('mouseup', (e) => {
            if (e.target.closest('#selection-toolbar')) return;

            const selection = window.getSelection();
            if (selection.toString().trim().length > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                selectionToolbar.style.left = `${rect.left + window.scrollX + rect.width / 2 - selectionToolbar.offsetWidth / 2}px`;
                selectionToolbar.style.top = `${rect.top + window.scrollY - selectionToolbar.offsetHeight - 10}px`;
                selectionToolbar.style.display = 'block';
            } else {
                selectionToolbar.style.display = 'none';
            }
        });

        document.addEventListener('mousedown', (e) => {
             if (!e.target.closest('#selection-toolbar')) {
                selectionToolbar.style.display = 'none';
             }
        });

        function applyStyle(className) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = className;
                
                try {
                    // Check if selection contains elements with the same class to "unwrap" them
                    const container = range.commonAncestorContainer;
                    const parentElement = container.nodeType === 3 ? container.parentNode : container;
                    if (parentElement.classList.contains(className)) {
                        const text = document.createTextNode(parentElement.textContent);
                        parentElement.parentNode.replaceChild(text, parentElement);
                    } else {
                         range.surroundContents(span);
                    }
                } catch (e) {
                     console.error("Could not surround contents:", e);
                }

                selection.removeAllRanges();
                selectionToolbar.style.display = 'none';
            }
        }
        
        document.getElementById('highlight-btn').addEventListener('click', () => applyStyle('highlighted-text'));
        document.getElementById('underline-btn').addEventListener('click', () => applyStyle('underlined-text'));
        document.getElementById('strikethrough-btn').addEventListener('click', () => applyStyle('strikethrough-text'));

        // --- TEXT NOTE LOGIC ---
        const addNoteBtn = document.getElementById('add-note-btn');
        addNoteBtn.addEventListener('click', () => {
            document.body.classList.add('add-note-mode');
            const currentSlide = Reveal.getCurrentSlide();
            
            const placeNoteHandler = (e) => {
                const slideRect = currentSlide.getBoundingClientRect();
                const x = e.clientX - slideRect.left;
                const y = e.clientY - slideRect.top;
                createNote(currentSlide, x, y);

                document.body.classList.remove('add-note-mode');
                currentSlide.removeEventListener('click', placeNoteHandler);
            };
            currentSlide.addEventListener('click', placeNoteHandler, { once: true });
        });

        function createNote(parent, x, y, content = '') {
            const note = document.createElement('div');
            note.className = 'text-note';
            note.style.left = `${x}px`;
            note.style.top = `${y}px`;

            note.innerHTML = `
                <div class="text-note-header">
                    <button class="close-btn">&times;</button>
                </div>
                <textarea>${content}</textarea>
            `;
            parent.appendChild(note);

            // Drag logic
            const header = note.querySelector('.text-note-header');
            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - note.getBoundingClientRect().left;
                offsetY = e.clientY - note.getBoundingClientRect().top;
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const slideRect = parent.getBoundingClientRect();
                    note.style.left = `${e.clientX - slideRect.left - offsetX}px`;
                    note.style.top = `${e.clientY - slideRect.top - offsetY}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            note.querySelector('.close-btn').addEventListener('click', () => {
                note.remove();
            });
        }
    </script>
</body>
</html>

