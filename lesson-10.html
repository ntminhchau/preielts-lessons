<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>Lesson 10 - Listening</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            font-size: 22px;
            color: #333;
            background-color: #fdfdfd;
            margin: 0;
            padding: 0;
        }
        #content-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px 40px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h2, h3, h4 {
            text-align: center;
            margin-bottom: 1em;
            color: #111;
        }
        h2 { font-size: 2.2em; }
        h3 { font-size: 1.8em; }
        audio {
            width: 100%;
            margin: 20px 0;
        }
        .exercise-form {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-top: 20px;
        }
        .exercise-form table { width: 100%; border-collapse: collapse; }
        .exercise-form td { padding: 10px; border: 1px solid #ddd; }
        .exercise-form td:first-child { font-weight: bold; width: 30%; }
        hr { margin: 40px 0; border: 0; border-top: 1px solid #eee; }

        /* === NEW INPUT STYLES === */
        .fill-in-blank {
            border: none;
            border-bottom: 1px solid #555;
            background-color: #f0f8ff;
            text-align: center;
            font-size: inherit;
            font-family: inherit;
            color: #005a9c;
            width: 200px;
            margin: 0 5px;
            padding: 2px;
        }
        .fill-in-blank:focus {
            outline: none;
            border-bottom: 2px solid #007bff;
            background-color: #e6f7ff;
        }


        /* === ANNOTATION STYLES === */
        .highlighted-text { background-color: rgba(255, 255, 0, 0.4); }
        .underlined-text { text-decoration: underline; text-decoration-color: #e63946; text-decoration-thickness: 3px; }
        .strikethrough-text { text-decoration: line-through; }

        #selection-toolbar {
            position: absolute; display: none; background: #333;
            border-radius: 5px; padding: 5px; z-index: 1000;
        }
        #selection-toolbar button {
            background: none; border: none; color: white;
            font-size: 16px; padding: 8px 10px; cursor: pointer;
            border-radius: 3px; min-width: 40px;
        }
        #selection-toolbar button:hover { background: #555; }

        #main-toolbar {
            position: fixed; top: 20px; left: 20px; z-index: 1001;
            background: rgba(0,0,0,0.7); padding: 8px; border-radius: 8px;
        }
        #main-toolbar button {
            background: #fff; color: #333; border: none;
            width: 40px; height: 40px; font-size: 18px;
            cursor: pointer; border-radius: 5px;
        }
        body.add-note-mode { cursor: crosshair; }

        .text-note {
            position: absolute; z-index: 999; border: 1px dashed transparent;
        }
        .text-note:hover { border-color: #ccc; }
        .text-note:hover .note-controls { display: flex; }
        .note-controls {
            position: absolute; top: -15px; right: 0; display: none;
            gap: 8px; align-items: center;
        }
        .note-controls .drag-handle { cursor: move; color: #555; }
        .note-controls .close-btn { cursor: pointer; border: none; background: none; font-size: 16px; }
        .text-note textarea {
            width: 300px; height: 100px; border: none; background: transparent;
            padding: 5px; resize: both; outline: none;
            font-family: inherit; font-size: 20px;
            color: #c92a2a; font-style: italic;
        }
    </style>
</head>
<body>
    <div id="main-toolbar">
        <button id="add-note-btn" title="Thêm ghi chú"><i class="fa-solid fa-font"></i></button>
    </div>

    <div id="selection-toolbar">
        <button id="highlight-btn" title="Highlight"><i class="fa-solid fa-highlighter"></i></button>
        <button id="underline-btn" title="Underline"><i class="fa-solid fa-underline"></i></button>
        <button id="strikethrough-btn" title="Strikethrough"><i class="fa-solid fa-strikethrough"></i></button>
        <button id="clear-format-btn" title="Xóa định dạng"><i class="fa-solid fa-text-slash"></i></button>
    </div>

    <div id="content-container">
        <h2>LISTENING: FORM AND NOTE COMPLETION</h2>
        <h4>Quy trình làm bài:</h4>
        <ol>
            <li>Đọc kỹ hướng dẫn (Vd: Write NO MORE THAN TWO WORDS...).</li>
            <li>Xác định cần điền TỪ hay SỐ.</li>
            <li>Xác định loại từ cần điền (danh từ, động từ, tính từ...).</li>
            <li>Nghe được – điền ngay vào bài.</li>
            <li>Nghe nhưng chưa chắc – ghi lại dữ kiện nghe được.</li>
            <li>Kiểm tra lại sau khi làm xong (chính tả, số ít/nhiều, ngữ pháp).</li>
        </ol>

        <hr>

        <h3>Exercise 1</h3>
        <audio controls src="Assets/lesson-10/audio/lesson-10-ex1.mp3"></audio>
        <p>Complete these notes with information from the flight arrivals board below.</p>
        <ul>
            <li>Spanish flight arrived at (1) <input type="text" class="fill-in-blank"></li>
            <li>Flight CCA1550 from (2) <input type="text" class="fill-in-blank"> arrived at 6.00</li>
            <li>Emirati flight no. (3) <input type="text" class="fill-in-blank"> delayed.</li>
            <li>Flight from Lison landed at terminal (4) <input type="text" class="fill-in-blank"></li>
        </ul>

        <hr>

        <h3>Exercise 2</h3>
        <audio controls src="Assets/lesson-10/audio/lesson-10-ex2.mp3"></audio>
        <p>You will hear a conversation between two friends planning a visit. Complete the notes.</p>
        <ul>
            <li>Sam arrives at: (1) <input type="text" class="fill-in-blank"> on (2) <input type="text" class="fill-in-blank"></li>
            <li>Airline: (3) <input type="text" class="fill-in-blank"> Flight number: (4) <input type="text" class="fill-in-blank"></li>
        </ul>

        <hr>

        <h3>Exercise 3</h3>
        <audio controls src="Assets/lesson-10/audio/lesson-10-ex3.mp3"></audio>
        <p>You will hear a telephone conversation in which Sam is booking a taxi. Complete the form.</p>
        <div class="exercise-form">
            <table>
                <tr><td>NAME OF PASSENGER:</td><td>SAM WILLIAMS</td></tr>
                <tr><td>PICK-UP DATE AND TIME:</td><td>Wed 6th July (1) <input type="text" class="fill-in-blank"></td></tr>
                <tr><td>PICK-UP POINT:</td><td>(2) <input type="text" class="fill-in-blank"> WILLOWSIDE BANK</td></tr>
                <tr><td>NO. & STREET:</td><td>(3) <input type="text" class="fill-in-blank"></td></tr>
                <tr><td>TOWN:</td><td>(4) <input type="text" class="fill-in-blank"></td></tr>
                <tr><td>POSTCODE:</td><td>(5) 07789 <input type="text" class="fill-in-blank" style="width: 150px;"></td></tr>
                <tr><td>DESTINATION:</td><td>HEATHROW - TERMINAL 5</td></tr>
            </table>
        </div>
    </div>

    <script>
        const contentContainer = document.getElementById('content-container');
        const selectionToolbar = document.getElementById('selection-toolbar');
        const addNoteBtn = document.getElementById('add-note-btn');

        // --- PERSISTENCE ---
        function saveState() {
            // Update input values before saving content
            contentContainer.querySelectorAll('.fill-in-blank').forEach(input => {
                input.setAttribute('value', input.value);
            });
            localStorage.setItem('lesson10_content', contentContainer.innerHTML);
        }

        function loadState() {
            const savedContent = localStorage.getItem('lesson10_content');
            if (savedContent) {
                contentContainer.innerHTML = savedContent;
            }
        }
        
        // --- SELECTION TOOLBAR LOGIC ---
        document.addEventListener('mouseup', (e) => {
            if (e.target.closest('#selection-toolbar')) return;
            setTimeout(() => {
                const selection = window.getSelection();
                if (selection && selection.toString().trim().length > 0) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    selectionToolbar.style.left = `${rect.left + window.scrollX + rect.width / 2 - selectionToolbar.offsetWidth / 2}px`;
                    selectionToolbar.style.top = `${rect.bottom + window.scrollY + 10}px`;
                    selectionToolbar.style.display = 'block';
                } else {
                    selectionToolbar.style.display = 'none';
                }
            }, 10);
        });

        document.addEventListener('mousedown', (e) => {
             if (!e.target.closest('#selection-toolbar')) {
                selectionToolbar.style.display = 'none';
             }
        });
        
        function styleSelection(className) {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) return;
            const range = selection.getRangeAt(0);
            const parentElement = range.commonAncestorContainer.nodeType === 3 ? range.commonAncestorContainer.parentNode : range.commonAncestorContainer;
            if (parentElement.classList.contains(className)) {
                 parentElement.replaceWith(...parentElement.childNodes);
            } else {
                const span = document.createElement('span');
                span.className = className;
                try {
                    const fragment = range.extractContents();
                    span.appendChild(fragment);
                    range.insertNode(span);
                } catch(e) { console.error("Wrapping failed", e); }
            }
            selection.removeAllRanges();
            selectionToolbar.style.display = 'none';
            saveState();
        }
        
        function clearFormatting() {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) return;
            const range = selection.getRangeAt(0);
            const fragment = range.extractContents();
            const spans = fragment.querySelectorAll('.highlighted-text, .underlined-text, .strikethrough-text');
            spans.forEach(span => { span.replaceWith(...span.childNodes); });
            range.insertNode(fragment);
            selection.removeAllRanges();
            selectionToolbar.style.display = 'none';
            saveState();
        }
        
        document.getElementById('highlight-btn').addEventListener('click', () => styleSelection('highlighted-text'));
        document.getElementById('underline-btn').addEventListener('click', () => styleSelection('underlined-text'));
        document.getElementById('strikethrough-btn').addEventListener('click', () => styleSelection('strikethrough-text'));
        document.getElementById('clear-format-btn').addEventListener('click', clearFormatting);

        // --- TEXT NOTE LOGIC ---
        addNoteBtn.addEventListener('click', () => {
            document.body.classList.add('add-note-mode');
            const placeNoteHandler = (e) => {
                const x = e.pageX;
                const y = e.pageY;
                createNote(x, y);
                document.body.classList.remove('add-note-mode');
            };
            setTimeout(() => { document.addEventListener('click', placeNoteHandler, { once: true }); }, 0);
        });

        function createNote(x, y, content = '') {
            const note = document.createElement('div');
            note.className = 'text-note';
            note.style.left = `${x}px`;
            note.style.top = `${y}px`;
            note.innerHTML = `
                <div class="note-controls">
                    <span class="drag-handle" title="Di chuyển"><i class="fa-solid fa-arrows-up-down-left-right"></i></span>
                    <button class="close-btn" title="Xóa">&times;</button>
                </div>
                <textarea placeholder="Gõ ghi chú...">${content}</textarea>
            `;
            document.body.appendChild(note);

            const textarea = note.querySelector('textarea');
            textarea.addEventListener('input', saveState);
            textarea.focus();

            const header = note.querySelector('.drag-handle');
            let isDragging = false, offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isDragging = true;
                offsetX = e.pageX - note.getBoundingClientRect().left - window.scrollX;
                offsetY = e.pageY - note.getBoundingClientRect().top - window.scrollY;
            });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    note.style.left = `${e.pageX - offsetX}px`;
                    note.style.top = `${e.pageY - offsetY}px`;
                }
            });
            document.addEventListener('mouseup', () => {
                if(isDragging) {
                    isDragging = false;
                    saveState();
                }
            });
            note.querySelector('.close-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                note.remove();
                saveState();
            });
        }
        
        // Initial load and setup listeners
        loadState();
        // Add event listeners for inputs to save on change
        contentContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('fill-in-blank')) {
                saveState();
            }
        });

    </script>
</body>
</html>

